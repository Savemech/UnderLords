\documentclass{article}
%\usepackage{arxiv}
\usepackage[utf8]{inputenc} % allow utf-8 input
%\usepackage[T1]{fontenc}    % use 8-bit T1 fonts
\usepackage{hyperref}       % hyperlinks
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography
\usepackage{lipsum}

\usepackage{amsmath, amsfonts, amsthm,amssymb}
\usepackage[english, russian]{babel}
\usepackage{graphicx}

\newtheorem{theorem}{Теорема}
%\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Лемма}
\newtheorem{corollary}{Следствие}
\newtheorem{proposition}{Предложение}
\newtheorem{assertion}{Утверждение}

% \title{NP-completeness and LP formulation of Dota Underlords problem}
% \title{Hacking Dota Underlords With Integer Programming Model}
\title{NP-полнота и формулировка целочисленного линейного программирования задачи Dota Underlords}


\author{
  Alexander A. ~Ponomarenko, Dmitry S. ~Sirotkin \\
  Laboratory of Algorithms and Technologies for Network Analysis\\
  National Research University Higher School of Economics \\
  Nizhny Novgorod, Russia\\
  \texttt{aponomarenko@hse.ru, dsirotkin@hse.ru} \\
  %% examples of more authors
  %% \AND
  %% Coauthor \\
  %% Affiliation \\
  %% Address \\
  %% \texttt{email} \\
  %% \And
  %% Coauthor \\
  %% Affiliation \\
  %% Address \\
  %% \texttt{email} \\
  %% \And
  %% Coauthor \\
  %% Affiliation \\
  %% Address \\
  %% \texttt{email} \\
}

\begin{document}
\maketitle

\begin{abstract}
В данной работе мы демонстрируем, как задача оптимального выбора состава команды в популярной компьютерной игре Dota Underlords может быть сведена к задаче целочисленного линейного программирования. Мы приводим модель и решаем её для конкретного экземпляра задачи. Также мы доказываем, что данная задача относится к классу NP-complete и показываем, что она сводится к хорошо изученной задаче нахождения в графе с взвешенными неотрицательными рёбрами клики с наибольшим суммарным весом рёбер. 
\end{abstract}


% keywords can be removed
%\keywords{Целочисленное программирование \and NP-трудность \and NP-полнота}


\section{Введение}

Люди любят играть в игры. Многие игры и головоломки, в которые люди играют, интересны из-за их сложности: для их решения требуется сообразительность. Часто эта трудность может быть показана математически в виде функции вычислительной сложности от размера входного набора данных. Например, было показано, что шахматы относятся к классу EXPTIME \cite{fraenkel1981computing}; задача выбора игрока  в легендарной видеоигре <<Тетрис>> относится классу NP-трудных \cite{breukelaar2004tetris}. Было показано, что игра-головоломка <<Сокобан>> (<<кладовщик>>, также известная для русскоговорящего населения под названием <<мудрый крот>>) полиномиально разрешима \cite{hearn2005pspace}.

Особое место в теории сложности вычислений занимает класс NP-полных задач (класс NP-complete). 
Было показано  \cite{kaye2000minesweeper}, что к классу NP-полных задач относится игра <<Сапёр>>. Задача нахождения решения требующего минимального количество передвижений фишек в обобщенной версии игры <<пятнашки>> для доски размером $N \times N$ тоже относится к классу NP-complete \cite{ratner1986finding}. 
В некотором смысле каждая NP-полная задача является загадкой, и наоборот, многие головоломки NP-полны. Для углубленного изучения темы вычислительной сложности для головоломок и игр, мы отсылаем читателя к обзору \cite{costa2018computational}.

В данной работе мы рассматриваем популярную видеоигру Dota Unlderlords. Она является представителем жанра auto-chess (<<автошахмат>> в переводе на русский). Как оказывается, данную задачу можно представить как задачу комбинаторной оптимизации, которая при некоторых естественных ограничениях принадлежит классу NP-complete.

Статья организована следующим образом. В разделе \ref{SectionDUDescription} рассказывается, игровой процесс Dota Underlords. Мы приводим формулировку задачи Dota Underlords в виде задачи линейного целочисленного программирования в разделе \ref{SectionDUIP}. В разделе \ref{SectionNPCompleteProof} мы показываем NP-полноту этой задачи. Результаты решения модели целочисленного программирования для реальных данных мы публикуем в разделе \ref{SectionComputationalResults}. И по традиции мы подводим итоги в секции \ref{SectionConclusion} <<Заключение>>.

\section{Описание игры Dota Underlords}
\label{SectionDUDescription}

По ходу игры восемь игроков составляют команду из <<героев>> – существ, способных сражаться друг с другом на игровой карте. У каждого из героев есть базовые параметры - здоровье, урон, скорость атаки и прочие, а также особая способность, которая определяет его роль в игре. Каждый герой принадлежит к двум или более <<альянсам>> - множествам, объединяющих нескольких героев. Так, например, герой Enchantress принадлежит одновременно к альянсу <<друиды>> и к альянсу <<хищники>>. При наборе нескольких героев из одного альянса (для каждого альянса это число индивидуально) игрок получает бонус, заключаемый в улучшении характеристик своих героев или ухудшении характеристик чужих.

Также в ходе игры можно усилить своих героев, путём улучшения их до более высоких уровней или путём покупки внутриигровых предметов. В рамках данной работы эти аспекты учитываться не будут.

Таким образом, сила команды игрока определяется:

\begin{enumerate}
    \item Силой выбранных героев
    \item Бонусами от альянсов в которых они состоят
\end{enumerate}


\section{Перевод задачи в язык линейного целочисленного программирования }
\label{SectionDUIP}

\subsection{Простейшая постановка задачи}

Формализуем задачу следующим образом:

Будем считать, что всего у нас в есть $n$ героев на выбор. Будем считать, что сила некоторого $i$-го героя определяется за некоторую неотрицательную величину $s_i$. За $x_i$ будем обозначать принадлежность героя выбранной команде. Условимся, что когда $x_i = 1$, если $i$-й герой принадлежит набранной команде и $x_i=0$ в противном случае. Тогда условие того, что в команде не более, чем $m$ героев можно записать в виде $\sum_{i=1}^n x_i \leq m$. Тогда в простейшей форме данную задачу можно сформулировать следующим образом:

\begin{equation}
\begin{gathered}
    max \sum_{i=1}^n x_i s_i \\
    \sum_{i=1}^n x_i \leq m \\
    x_i \in \{0, 1\} \text{ – управляющая переменная} \\
   n, m, s_i \text{ – константы}  \\
\end{gathered}
\end{equation}

В данной постановке задача решается элементарно – достаточно взять $n$ элементов с наибольшими весами.

\subsection{Постановка задачи с альянсами}
Как было упомянуто, в <<Dota Underlords>>  каждый герой принадлежит к двум или более <<альянсам>> - классам, в которые входят несколько героев.  Когда в команде присутствует несколько героев из одного альянса (для каждого альянса это число индивидуально) игрок получает бонус, который выражается в усилении всех героев из альянса, усилении всех своих героев или ослаблении всех героев соперника. Последнее может быть интерпретировано как относительное усиление своих героев и поэтому на протяжении работы будут рассматриваться только первые два случая. Следует отметить, что для одного альянса может быть несколько бонусов, которые открываются разным количеством героев соответствующего альянса, при этом они могут быть разного типа.


Данную ситуацию мы предлагаем моделировать с помощью введения 3-х индексного тензора $e_{ijk} \in \mathbb{R}$ означающего бонус герою $i$, за альянс $j$, в котором присутствуют не менее $k$ героев альянса $j$. Другими словами, $e_{ijk}$ это $k$-й бонус альянса $j$ для героя $i$.

С помощью тензора $e_{ijk}$ можно поддерживать два типа альянсов – те которые дают бонусы своим членам и те, которые дают бонусы всем героям игрока. При этом, альянсы рассмотренных видов отличаются только тем, что в альянсах, дающих бонус своим членам, величина $e_{ijk}$ равна нулю тогда и только тогда, когда $i$-й герой не принадлежит $j$-му альянсу. Заметим, что тензор  $e_{ijk}$  будет сильно разрежен, поскольку альянсы, от которых бонусы идут всем героям немного.  
Контролировать вхождения бонуса $e_{ijk}$ в общую силу команды предлагается с помощью управляющей бинарной переменной $I_{ijk}$.
Так мы можем записать целевую функцию как следующую сумму $\sum_{i=1}^{n} x_i s_i + \sum_{i=1}^{n} \sum_{j=1}^{t} $.
Связь переменных $x_{i}$ и $I_{ijk}$ задаётся неравенствами
$\forall{i,j,k} :  \sum_{i'=1}^{n} a_{i'j} x_{i'} - k \ge M( I_{ijk}  - 1)$. 
%\textbf{Здесь надо вставить пару предложений про эти неравенства, в чём логика этой связи} 
Они не дают бинарной переменной $I_{ijk}$ принимать значение 1, если в решение входит меньше чем $k$ героев входящих в альянс $j$. Когда решение содержит героев из альянса $j$ меньше чем $k$, левая часть этого неравенства отрицательная, поэтому чтобы неравенства соблюдались правая часть должна быть ещё меньше. Такое возможно только, когда бинарная $I_{ijk}$ равно нулю. В этом случае правая часть равна $-М$, где $М$ константа заведомо большая, чем $k$, то есть больше, чем максимальный размер альянса $q$.
Разумно требовать, чтобы бонус для героя $i$ мог быть активирован ($I_{ijk} = 1$ ), только когда герой $i$ входит в решение. Это задаётся неравенствами $\forall{i,j,k} :  I_{ijk}  \le x_i$. Также мы хотим, чтобы бонус $e_{ijk}$ был активирован, только для если герой $i$ принадлежит альянсу $j$. Для этого мы в модель включили неравенства $\forall{i,j,k} :  I_{ijk}  \le a_{ij}$.   

Таким образом, после введения в модель альянсов, система уравнений выглядит следующим образом.

\begin{equation}
\label{eq:DUIP}
\begin{gathered}
\textbf{Целевая функция}\\
max \sum_{i=1}^{n} x_i s_i + \sum_{i=1}^{n} \sum_{j=1}^{t}  \sum_{k=1}^{q} e_{ijk} I_{ijk} \\
\textbf{Ограничения на входные данные}\\
\forall{j} : \sum_{i=1}^n a_{ij} \le q \\
\textbf{Ограничения на управляющие переменные} \\
\forall{i,j,k} :  \sum_{i'=1}^{n} a_{i'j} x_{i'} - k \ge M( I_{ijk}  - 1) \\
\sum_{i=1}^n x_i \le m   \\ 
% \sum_{i=0}^{n-1} a_{ij} x_{i} < k \\ 
\forall{i,j,k} :  I_{ijk}  \le x_i \\
%\forall{i,j,k} :  I_{ijk}  \le a_{ij} \\
\textbf{Управляющие переменные} \\
I_{ijk} \in \{0, 1\} \text {, 1 – если для героя } i \text{, активирован} k\text{-й бонус } j \text{-го альянса,} \\
x_i  \in \{0, 1\} \text{, 1 -- если герой } i \text{– входит в решение} \\
\textbf{Константы} \\
n \in \mathbb{N} \text{ -- число героев,} \\
m \in \mathbb{N} \text{ -- максимальный размер команды}\\
t \in \mathbb{N} \text{ -- общее количество альянсов} \\
q \in \mathbb{N} \text{ -- максимальный размер одного альянса,} \\
s_i  \in \mathbb{R} \text{–- сила героя } i, \\
e_{ijk} \in \mathbb{R} \text{ -- бонус для героя } i \text{,  если активирован } k
\text{-й бонус } j \text{-го альянса} \\
a_{ij} \in \{0, 1\} \text{, 1 -- если герой } i \text{ входит в альянс } j \\ 
\end{gathered}
\end{equation}

\section{Доказательство принадлежности задачи Dota Underlords к классу NP-полных}
\label{SectionNPCompleteProof}

Чтобы доказать, что задача $T$ является NP-полной необходимо показать, что она является одновременно NP-трудной задачей и принадлежит к классу NP. Докажем оба этих утверждения.

\subsection{Сведение задачи о поиске максимально плотного подграфа к UnderLords}

\begin{theorem}
\label{MEWC_DU}
Задача о поиске максимального плотного подграфа из $k$ вершин сводится к задаче UnderLords.
\end{theorem}
\begin{proof}
Рассмотрим её частный случай -- пусть все альянсы имеют размер равный двум, и сила всех героев одинакова. Рассмотрим частный случай задачи Dota Underlords со следующими ограничениями:

\begin{enumerate}
    \item Силы всех героев одинаковы ($\forall i, j s_i=s_j$)
    \item Альянсы могут давать бонусы исключительно героям в них состоящим ($\forall i, j, k a_{ij}=0 \Longrightarrow e_{ijk} = 0$)
    \item Все альянсы имеют одинаковый размер, равный двум ($\forall j \sum_i a_{ij}=2$)
    \item Все альянсы дают бонус исключительно при наличии в них обоих героев ($\forall i, j e_{ij1}=0$)
    \item Бонусы ото всех альянсов равны ($\forall i, j, i', j' a_{ij}=1, a_{i' j'}=1 \Longrightarrow e_{ij2}=e_{i' j' 2}$)
\end{enumerate}

Тогда данные можно представить в виде графа $G(V, E)$, где множество вершин $V$ соответствует героям, а множество рёбер $E$ - активным альянсам. Можно заметить, что в этом случае оптимальная команда размером $k$ соответствует максимально плотному подграфу $G' \subset G$, состоящего из $k$ вершин. Под плотностью в данной формулировке может понимается величина $\frac{G'(E)}{G'(V)}$. Действительно, при данных ограничениях общая сила команды линейно зависит от количества активных альянсов, что соответствует $G'(E)$. Поскольку $k$ неизменно, то с ростом плотности графа $G'$ растёт итоговая сила команды.

В работе \cite{downey1995fixed} было показано, что задача поиска порождённого подграфа с максимальной плотностью и фиксированным размером в графе, является NP-полной. Как было показано, она является частным случаем задачи Dota Underlords и к ней сводится. 

Отсюда следует, что задача Dota  Underlords не менее трудна, чем известная NP-полная задача. Таким образом,  задача Dota  Underlords NP-трудна.
\end{proof}

\subsection{Принадлежность Dota UnderLords к классу NP}
Задача Dota UnderLords в варианте зачи с ответом <<да>>> или <<нет>>  может быть сформулирована следую образом. \textit{Существует ли команда из небольше, чем $m$ героев и силой большей, чем некоторая заданная константа?}.

Сформулируем следующую теорему.
\begin{theorem}
\label{DU_is_NP}
Задача Dota UnderLords в варианте зачи с ответом <<да>> или <<нет>>  принадлежит классу NP.
\end{theorem}
\begin{proof}
По определению класса NP, задача тогда принадлежит класс NP, когда предъявленное решение на ответ <<да>>, может быть проверено за полиномиальное время. В нашем случае, решение это будет набор героев. Для проверки правильности нам требуется оценить силу команды. Для этого требуется оценить какие альянсы образовались и какой размер бонуса. В свою очередь, это можно сделать за время $O(n \times m  \times  q)$. Таким образом утверждение доказано.
\end{proof}

\subsection{NP-полнота задачи Dota UnderLords}
%Можно вставить текст про то, как да/нет версия формулируется. И как с её помощью решается задача DU  за логарифмическую сложность методом бинарного поиска. Тем самым оставаясь в классе np-complete

\begin{theorem}
    Задача Dota Underlords задаваемая системой неравенств \eqref{eq:DUIP} принадлежит классу NP-полных задач $q$.
\end{theorem}

\begin{proof}
	Теорема \ref{MEWC_DU} утверждает, что существует полиномиальное сведение NP-полной задаче к DU. Вместе с тем, теоремой \ref{DU_is_NP} мы показали, что задача DU принадлежит к классу NP. Таким образом, задача DU NP-трудна, и при этом сам лежит в классе NP. То есть Dota UnderLords в версии <<Да/Нет>> принадлежит классу NP-полных задач. 
\end{proof}

\subsection{Сведение Dota UnderLords к максимальной взвешенной клике}
В процессе создания данной статьи мы также нашли способ сведения задачи Dota UnderLords к хорошо известной задаче о максимальной взвешенной по рёбрам клике  (Maximum Edge Weighted Clique скор. MEWC). Таким образом, при решении индивидуаьлных экземпляров задачи Dota Underlords можно использовать уже разработанные алгоритмы для задачи MEWC.

В данном сведении мы будем рассматривать задачу, в которой максимальный размер альянса $q$ ограничен некоторой константой.

Доказательство будет проводится последовательно, через серию теорем, каждая из которых описывает сведение всё менее и менее ограниченной версии задачи к задаче о максимальной взвешенной по рёбрам клике.

%------------------------------------------------------------------------------------------------------------

%Наша цель будет заключаться в построении графа $G(V, E)$ таким образом, чтобы в нём максимальная взвешенная рёберная клика (MEWC) соответствовала оптимальному решению задачи Dota Underlords (DU).

%В графе $G$ мы будем выделять $q$ семейств множеств вершин $V:= \{ \mathcal{F}_1 \cup \mathcal{F}_2  \cup ... \cup \mathcal{F}_q \} $, где $q$ – максимальный возможный размер альянса.   
%
%Мы будем ассоциировать с каждой вершиной $v_i$ из множества $ \mathcal{F}_1 = \{v_1, v_2, ...v_n \}$  мы будем ставить в соответствие героя $i$. 
%
%Сила героев распределена по множеству рёбер. Сила героя $i$ заключается в рёбрах смежных с вершиной $v_i$, соответствующей этому герою.
%Факт образования  альянса моделируется введением дополнительных вершин соответствующих всевозможным сочетаниям героев в альянсе.
%
%Бонус за одновременное присутствие в команде героев ($ множество S $ ) из одного альянса  для героя   $c$, также входящего в состав команды, располагается на ребре $(v_c, V^S )$. При этом герой $c$ может как принадлежать множеству $S$, так и не принадлежать (случай, когда бонус от альянса распространяется на героев вне альянса. например, на всю команду). 

\begin{theorem}
\label{trivial_case}
    Задача Dota Underlords без альянсов сводится к задаче о максимальной взвешенной по рёбрам клике.
\end{theorem}
\begin{proof}
    Построим граф $G$ со взвешенными рёбрами такой, что из решения задачи MEWC следует решение задачи DU. При этом размер задачи MEWC ограничен полиномом от размера задачи DU. 
    
    Построим множество $V^1$ из $n$ вершин, соответствующее множеству героев в задаче DU. Каждой вершине поставим соответствие одного из героев из задачи DU --- или, иначе говоря, назовём каждую вершину в честь одного из героев задачи DU. Пронумеруем эти вершины соответственно порядку героев $v_1^1$, $v_2^1$, ..., $v_n^1$
    
    Построим дополнительно $m-1$ множеств вершин $V^2$, $V^3$ и так далее до $V^m$, в каждом из которых также назовём по одной вершине в честь одного из героев задачи DU. Аналогично первому множеству, пронумеруем вершины в множестве $V^i$ как $v_1^i$, $v_2^i$, ..., $v_n^i$.
    
    Обозначим семейство этих множеств за $\mathcal{F}$. Таким образом мы получим $m$ множеств по $n$ вершин каждое, при этом в каждом множестве есть по одной вершине, соответствующей каждому из героев.
    
    Проведём рёбра следующим образом --- в графе между вершинами $v_a^i$ и $v_{a'}^{i'}$ проводится ребро, если выполняются оба следующих условия:
    \begin{itemize}
        \item Вершины $v_a^i$ и $v_{a'}^{i'}$ соответствуют разным героям ($a \neq a'$)
        \item Вершины $v_a^i$ и $v_{a'}^{i'}$ лежат в разных множествах из семейства $F$ ($i \neq i'$)
    \end{itemize}
    
    Рассмотрим все максимальные клики в данном графе. Очевидно, что в любой такой клике есть ровно по одной вершине из каждого из множеств $V^i$ --- всего $m$ вершин. Также все эти вершины соответствуют разным героям. Таким образом каждая клике задаёт некоторую команду из героев в задаче DU. При этом стоит отметить, что каждой команде может соответствовать несколько клик.
    
    Теперь расставим на рёбрах веса. Для этого ребру, соединяющем вершины $s_a^i$ и $s_{a'}^{i'}$ припишем вес $\frac{s_a}{m-1} + \frac{s_{a'}}{m-1}$. Покажем, что сумма весов рёбер в клике, соответствующей некоторой команде есть в точности сила этой команды. 
    
    Действительно, в клике для каждой её вершины есть ровно $m-1$ ребро, ей инцидентное. Тогда каждое слагаемое $\frac{s_i}{m-1}$ соответствующее вершине с нижним индексом $i$ входит в сумму ровно $m-1$ раз. Отсюда следует, что сумма всех весов рёбер в клике есть сумма всех величин $s_i$, соответствующих номерам вершин, образующим данную клику.
\end{proof}

\begin{theorem}
\label{second_case}
    Задача Dota Underlords c альянсами размера ровно 2, сводится к задаче о максимальной взвешенной по рёбрам клике.
\end{theorem}

\begin{proof}
    Построим граф $G'$ со взвешенными рёбрами такой, что из решения задачи MEWC следует решение задачи DU. При этом размер задачи MEWC ограничен полиномом от размера задачи DU.
    
    Возьмём в качестве основы для построения граф $G$ из теоремы \ref{trivial_case}.
    
    Построим множество $W^{1,2}$ из $\binom{n}{2}$ вершин, где каждая вершина соответствует неупорядоченной паре героев. Пронумеруем эти вершины в лексикографическом порядке, соответственно порядку пар $w_{1,2}^1$, $w_{1,3}^1$, ..., $w_{n-1,n}^1$
    
    Построим дополнительно $\binom{m}{2}-1$ множеств вершин $W^{13}$, $W^{14}$ и так далее до $W^{m-1 m}$, в каждом из которых также сопоставим по вершине неупорядоченной паре героев задачи DU. Аналогично первому множеству, пронумеруем вершины в множестве $V^{i,j}$ как $w_1^{i,j}$, $w_2^{i,j}$, ..., $w_{n-1,n}^{i,j}$.
    
    Обозначим семейство этих множеств за $\mathcal{F}_2$. Таким образом мы получим $\binom{m}{2}$ множеств по $\binom{n}{2}$ вершин каждое, при этом в каждом множестве есть по одной вершине, соответствующей каждой паре героев.
    
    Проведём дополнительные рёбра следующим образом --- в графе между вершинами $w_{a,b}^{i,j}$ и $w_{a',b'}^{i',j'}$ проводится ребро, если выполняются оба следующих условия:
    \begin{itemize}
        \item Вершины $w_{a,b}^{i,j}$ и $w_{a',b'}^{i', j'}$ соответствуют разным парам героев ($a \neq a' \lor b \neq b'$)
        \item Вершины $w_{a,b}^{i,j}$ и $w_{a',b'}^{i', j'}$ лежат в разных множествах из семейства $F_2$ ($i \neq i' \lor j \neq j'$)
    \end{itemize}
    
    Также проведём все рёбра между всеми вершинами множеств $F$ и $F_2$. Всем свежепроведённым рёбрам припишем вес 0. Очевидно, что любая максимальная клика содержит по одной вершине из каждого из множеств $V$ и $W$ семейств $\mathcal{F}$ и $\mathcal{F}_2$. 
    
    Припишем каждому ребру вида $(v_a^k, w_{a,b}^{i,j})$ или $(v_b^k, w_{ab}^{i j})$ некоторый высокий константный вес $N$. Данные рёбра соединяют вершину из семейства $\mathcal{F}$, соответствующую некоторому герою с вершиной из семейства $F_2$, соответствующей паре героев, куда этот герой входит. Покажем, что любая максимальная клика в таком графе, содержащая множество вершин из семейства $\mathcal{F}$, соответствующих некоторому набору героев, также содержит и набор вершин из семейства $\mathcal{F}_2$, соответствующий всем парам героев из этого набора.
    
    В данной клике, рёбра, соединяющие вершины из семейств $\mathcal{F}$ и $\mathcal{F}_2$ вносят суммарный вклад в вес, равный $2 \binom{n}{2} N$, т.к. в неё входит ровно $2 \binom{n}{2}$ рёбер с добавленным высоким константным весом $N$ --- по два, инцидентных каждой вершине из $\mathcal{F}_2$. Отметим, что при взятии в клику из семейства $\mathcal{F}_2$ любой вершины, не соответствующей паре взятых вершин из $\mathcal{F}$ среди рёбер клики будет менее двух рёбер с добавленным высоким константным весом $N$. Таким образом, данная клика не будет максимальной по весу.
    
Таким образом, утверждение доказано. Отметим, что добавление на рёбра весов, малых по сравнению с $N$ сохраняет истинность утверждения. Поскольку $N$ берётся произвольно, можно считать, что все числовые значения сил и бонусов малы по сравнению с $N$.

Добавим тогда к весам рёбер вида  $(v_c^{k}, w_{a,b}^{i,j} )$ , соединяющих вершины из множеств 
$\mathcal{F}$ и $\mathcal{F}_2$ бонусы, которые альянс из пары героев под номерами $a$ и $b$ даёт герою под номером $c$. Тогда, если в выбранной команде есть герои $a$, $b$ и $c$, то в вес данной клики будет включён этот бонус. Поскольку во все рассматриваемые клики включено одинаковое количество рёбер с добавленным весом $N$, то максимальной будет та клика, где максимальной будет сумма сил героев (сумма весов рёбер между вершинами семейства $\mathcal{F}$) и бонусов (веса рёбер между вершинами семейств $\mathcal{F}$ и $\mathcal{F}_2$ без учёта констант $N$).
    
Таким образом, вес клики соответствует суммарному бонусу от команды, откуда и видно сведение.
    
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Теорема для случая альянса размером k
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{theorem}
\label{general_case}
    Задача Dota Underlords c альянсами максимального размера  $q$, сводится к задаче о максимальной взвешенной по рёбрам клике.
\end{theorem}
	Доказательство будем строить аналогично доказательству теоремы \ref{second_case}. 
Мы будем создавать дополнительные вершины ассоциируемые со всеми возможными сочетаниями из $q$ героев. Бонусы от образования соответствующих альянсов будут также как и в теореме \ref{second_case} находится на рёбрах.
Главным отличием будет, что у вершин вместо двух индексов будет использоваться $q$ индексов. Формальные рассуждения приведены ниже.
\begin{proof}
    Построим граф $G'$ со взвешенными рёбрами такой, что из решения задачи MEWC следует решение задачи DU. При этом размер задачи MEWC ограничен полиномом от размера задачи DU.
    
    Возьмём в качестве основы для построения граф $G$ из теоремы \ref{trivial_case}.
    
    Построим множество $ W^{1, q }$ из $\binom{n}{q}$ вершин, где каждая вершина соответствует неупорядоченной множеству из $q$ героев. Пронумеруем эти вершины в лексикографическом порядке, соответствующему порядку нумерации сочечетаний из $\binom{n}{q}$ элементов $w^1_{ \underbrace{1,2,...,q}_\text{total $q$ indices}}, w^1_{\underbrace{1,2,...,q+1}_\text{total $q$ indices}},..., w^1_{ \underbrace{ n-q, n-q+1,..., n-1,n}_\text{total $q$ indices}} $. То есть у каждого элемента есть ровно $q$ нижних индексов.

    Построим дополнительно $\binom{m}{q}-1$ множеств вершин $W^{1,2,...,q}$, $W^{1,2,q+1}$ и так далее до $W^{n-q, n-q+1,..., n-1,n}$, в каждом из которых также сопоставим по вершине неупорядоченной паре героев задачи DU. Аналогично первому множеству, пронумеруем вершины в множестве $V^{\overbrace{i,j,k,l,...}^\text{total $q$ indices}}$ как $w_{\underbrace{1,2,...,q}_\text{total $q$ indices}}^{\overbrace{i,j,k,l,...}^\text{total $q$ indices}}$, $w_{\underbrace{1,2,...,q+1}_\text{total $q$ indices}}^{\overbrace{i,j,k,l,...}^\text{total $q$ indices}}$, ..., $w_{ \underbrace{ n-q, n-q+1,..., n-1,n}_\text{total $q$ indices}}^{\overbrace{i,j,k,l,...}^\text{total $q$ indices}}$.
    
    Обозначим семейство этих множеств за $\mathcal{F}_q$. Таким образом мы получим $\binom{m}{q}$ множеств по $\binom{n}{q}$ вершин каждом, при этом в каждом множестве есть по одной вершине, соответствующей каждой паре героев.
    
    Проведём дополнительные рёбра следующим образом --- в графе между вершинами $w_{\underbrace{a, b, c, ....}_\text{total $q$ indices}}^{\overbrace{i,j,k,...}^\text{total $q$ indices}}$ и $w_{\underbrace{a', b', c', ....}_\text{total $q$ indices}}^{\overbrace{i',j',k',...}^\text{total $q$ indices}}$ проводится ребро, если выполняются оба следующих условия:
    \begin{itemize}
        \item Вершины $w_{a,b,c,...}^{i,j,k...}$ и $w_{a',b',c',...}^{i', j',k',...}$ соответствуют разным парам героев ($a \neq a' \lor b \neq b' \lor c \neq c',...$)
        \item Вершины $w_{a,b,c,...}^{i,j,k...}$ и $w_{a',b',c'...}^{i', j',k'...}$ лежат в разных множествах из семейства $F_q$ ($i \neq i' \lor j \neq j' \lor k \neq k',... $)
    \end{itemize}
    
    Также проведём все рёбра между всеми вершинами множеств $F$ и $F_q$. Всем свежепроведённым рёбрам припишем вес 0. Очевидно, что любая максимальная клика содержит по одной вершине из каждого из множеств $V$ и $W$ семейств $\mathcal{F}$ и $\mathcal{F}_q$. 
    
    Припишем каждому ребру вида $(v_a^k, w_{a,b,c,...}^{i,j,k,...})$ или $(v_b^k, w_{a,b,c,...}^{i, j,k,...})$ некоторый высокий константный вес $N$. Данные рёбра соединяют вершину из семейства $\mathcal{F}$, соответствующую некоторому герою с вершиной из семейства $F_q$, соответствующей набору из $q$ героев, в который этот герой входит. Покажем, что любая максимальная клика в таком графе, содержащая множество вершин из семейства $\mathcal{F}$, соответствующих некоторому набору героев, также содержит и набор вершин из семейства $\mathcal{F}_q$, соответствующий всем парам героев из этого набора.
    
    В данной клике, рёбра, соединяющие вершины из семейств $\mathcal{F}$ и $\mathcal{F}_q$ вносят суммарный вклад в вес, равный $2 \binom{n}{q} N$, т.к. в неё входит ровно $2 \binom{n}{q}$ рёбер с добавленным высоким константным весом $N$ --- по два, инцидентных каждой вершине из $\mathcal{F}_q$. Отметим, что при взятии в клику из семейства $\mathcal{F}_q$ любой вершины, не соответствующей паре взятых вершин из $\mathcal{F}$ среди рёбер клики будет менее двух рёбер с добавленным высоким константным весом $N$. Таким образом, данная клика не будет максимальной по весу.
    
Таким образом, утверждение доказано. Отметим, что добавление на рёбра весов, малых по сравнению с $N$ сохраняет истинность утверждения. Поскольку $N$ берётся произвольно, можно считать, что все числовые значения сил и бонусов малы по сравнению с $N$.

Добавим тогда к весам рёбер вида  $(v_c^{k}, w_{a',b',c',...}^{i',j',k',...} )$ , соединяющих вершины из множеств 
$\mathcal{F}$ и $\mathcal{F}_q$ бонусы, которые альянс из множества героев под номерами $a', b', c',...$ даёт герою под номером $c$. Тогда, если в выбранной команде есть герои $a$, $b$ и $c$, то в вес данной клики будет включён этот бонус. Поскольку во все рассматриваемые клики включено одинаковое количество рёбер с добавленным весом $N$, то максимальной будет та клика, где максимальной будет сумма сил героев (сумма весов рёбер между вершинами семейства $\mathcal{F}$) и бонусов (веса рёбер между вершинами семейств $\mathcal{F}$ и $\mathcal{F}_q$ без учёта констант $N$).
    
Таким образом, вес клики соответствует суммарному бонусу от команды, откуда и видно сведение.
    
\end{proof}




\section{Практическое применение для реальной задачи Dota Underlords}
\label{SectionComputationalResults}
  
Мы применяем данную модель для анализа реальной задачи Dota Underlords. Отметим, что полученные результаты не стоит считать некоторой объективной оценкой качества команды героев. Причина состоит в неизбежном упрощении силы героев и влияния, которое оказывают альянсы. Каждый герой в Underlords обладает некоторой способностью, которая активируется при заполнении выполнении различных условий и обладает некоторым временем перезарядки. Способности и бонусы альянсов также весьма разнообразны по своему влиянию на игру - они могут наносить урон, лечить союзников, мешать врагам пользоваться своими способностями и прочее. К счастью, в игре есть система из пяти <<ярусов>>, устроенная так, что герои внутри яруса примерно равны по силе.

В рамках упрощённой модели мы принимаем следующее:
\begin{enumerate}
\item Силы всех героев первого яруса равны 1, второго 2, третьего - 3, четвертого - 4, пятого - 5;
\item Альянсы дают один и тот же процентный бонус всем, на кого они одинаково влияют;
\item Бонус от альянса составляет примерно 10-30 процентов от силы героя.
\end{enumerate}

Информация о силе героев и структуре альянсов приведена приведена в таблице \ref{table:aliances}. 
Полная таблица, задающая матрицу бонусов от альянсов $e_{ijk}$ может быть найдена в нашем \href{https://github.com/aponom84/UnderLords/blob/master/UnderLordsData.xlsx}{репозитории} \cite{UnderLordsInput}.

\begin{table}
\center
\resizebox{!}{9cm} {
\begin{tabular}{llrl}
{№} &                 Герой &  Сила &                       Альянсы \\
\midrule
0  &                 tusk &      1 &               savage, warrior  \\
1  &           venomancer &      1 &               scaled, summoner \\
2  &         shadow demon &      1 &               demon, heartless \\
3  &          drow ranger &      1 &    heartless, hunter, vigilant \\
4  &          bloodseeker &      1 &           blood-bound, deadeye \\
5  &         nyx assassin &      1 &               assassin, insect \\
6  &       crystal maiden &      1 &                    human, mage \\
7  &                 tiny &      1 &           primordial, warrior  \\
8  &             batrider &      1 &                  knight, troll \\
9  &               magnus &      1 &                  druid, savage \\
10 &             snapfire &      1 &                 brawny, dragon \\
11 &           arc warden &      1 &           primordial, summoner \\
12 &                razor &      1 &               mage, primordial \\
13 &               weaver &      1 &                 hunter, insect \\
14 &              warlock &      1 &  blood-bound, healer, warlock  \\
15 &               dazzle &      2 &                  healer, troll \\
16 &         earth spirit &      2 &               spirit, warrior  \\
17 &         storm spirit &      2 &                   mage, spirit \\
18 &         witch doctor &      2 &                troll, warlock  \\
19 &          bristleback &      2 &                 brawny, savage \\
20 &     legion commander &      2 &                champion, human \\
21 &        queen of pain &      2 &                assassin, demon \\
22 &     nature's prophet &      2 &                druid, summoner \\
23 &                 luna &      2 &               knight, vigilant \\
24 &           windranger &      2 &               hunter, vigilant \\
25 &            ogre magi &      2 &       blood-bound, brute, mage \\
26 &                pudge &      2 &            heartless, warrior  \\
27 &          beastmaster &      2 &                 brawny, hunter \\
28 &         chaos knight &      2 &                  demon, knight \\
29 &              slardar &      2 &               scaled, warrior  \\
30 &              abaddon &      3 &              heartless, knight \\
31 &                viper &      3 &               assassin, dragon \\
32 &           juggernaut &      3 &               brawny, warrior  \\
33 &         ember spirit &      3 &               assassin, spirit \\
34 &                   io &      3 &              druid, primordial \\
35 &         shadow fiend &      3 &                demon, warlock  \\
36 &                lycan &      3 &        human, savage, summoner \\
37 &          broodmother &      3 &               insect, warlock  \\
38 &            morphling &      3 &               mage, primordial \\
39 &          lifestealer &      3 &               brute, heartless \\
40 &           omniknight &      3 &          healer, human, knight \\
41 &          terrorblade &      3 &                  demon, hunter \\
42 &        shadow shaman &      3 &                summoner, troll \\
43 &               enigma &      3 &               primordial, void \\
44 &     treant protector &      3 &                   brute, druid \\
45 &                 doom &      4 &                   brute, demon \\
46 &            disraptor &      4 &               brawny, warlock  \\
47 &          void spirit &      4 &                   spirit, void \\
48 &               mirana &      4 &               hunter, vigilant \\
49 &           tidehunter &      4 &               scaled, warrior  \\
50 &            necrophos &      4 &    healer, heartless, warlock  \\
51 &           lone druid &      4 &        druid, savage, summoner \\
52 &                 sven &      4 &          human, knight, scaled \\
53 &                slark &      4 &               assassin, scaled \\
54 &     templar assassin &      4 &       assassin, vigilant, void \\
55 &  keeper of the light &      4 &                    human, mage \\
56 &                  axe &      5 &                  brawny, brute \\
57 &        faceless void &      5 &                 assassin, void \\
58 &            sand king &      5 &                 insect, savage \\
59 &                 lich &      5 &                heartless, mage \\
60 &               medusa &      5 &                 hunter, scaled \\
61 &        dragon knight &      5 &          dragon, human, knight \\
62 &        troll warlord &      5 &                troll, warrior  \\
\bottomrule
\end{tabular}
}
\caption{Таблица силы героев и принадлежности их к альянсам. }
\label{table:aliances}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  RESULT TABLE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Мы приводим решение модели целочисленного программирования, задаваемой системой неравенств  \eqref{eq:DUIP}, в виде таблицы \ref{table:solution}.

\begin{table}
\resizebox{16cm}{!} {
\begin{tabular}{l| *{8}{p{1.6cm}} | *{3}{ p{1cm}} }
{Герой} &                   &               &                &                &                &                  &                  &                  &  Вклад альянса &  Сила героев &   сумма \\
\midrule
broodmother   &  heartless 2 +0.3  &  human 2 +0.3  &  insect 2 +0.3  &  scaled 2 +0.6  &   troll 2 +0.3  &  warlock  2 +0.6  &  warlock  4 +0.6  &                   &                  3.0 &           3 &   6.0 \\
disruptor     &  heartless 2 +0.4  &  human 2 +0.4  &  insect 2 +0.4  &  scaled 2 +0.8  &   troll 2 +0.4  &  warlock  2 +0.8  &  warlock  4 +0.8  &                   &                  4.0 &           4 &   8.0 \\
dragon knight &  heartless 2 +0.5  &  human 2 +0.5  &  insect 2 +0.5  &  knight 2 +1.0  &  scaled 2 +1.0  &     troll 2 +0.5  &  warlock  2 +0.5  &  warlock  4 +0.5  &                  5.0 &           5 &  10.0 \\
lich          &  heartless 2 +0.5  &  human 2 +0.5  &  insect 2 +0.5  &  scaled 2 +1.0  &   troll 2 +0.5  &  warlock  2 +0.5  &  warlock  4 +0.5  &                   &                  4.0 &           5 &   9.0 \\
medusa        &  heartless 2 +0.5  &  human 2 +0.5  &  insect 2 +0.5  &  scaled 2 +1.0  &   troll 2 +0.5  &  warlock  2 +0.5  &  warlock  4 +0.5  &                   &                  4.0 &           5 &   9.0 \\
necrophos     &  heartless 2 +0.4  &  human 2 +0.4  &  insect 2 +0.4  &  scaled 2 +0.8  &   troll 2 +0.4  &  warlock  2 +0.8  &  warlock  4 +0.8  &                   &                  4.0 &           4 &   8.0 \\
sand king     &  heartless 2 +0.5  &  human 2 +0.5  &  insect 2 +0.5  &  scaled 2 +1.0  &   troll 2 +0.5  &  warlock  2 +0.5  &  warlock  4 +0.5  &                   &                  4.0 &           5 &   9.0 \\
sven          &  heartless 2 +0.4  &  human 2 +0.4  &  insect 2 +0.4  &  knight 2 +0.8  &  scaled 2 +0.8  &     troll 2 +0.4  &  warlock  2 +0.4  &  warlock  4 +0.4  &                  4.0 &           4 &   8.0 \\
troll warlord &  heartless 2 +0.5  &  human 2 +0.5  &  insect 2 +0.5  &  scaled 2 +1.0  &   troll 2 +1.0  &  warlock  2 +0.5  &  warlock  4 +0.5  &                   &                  4.5 &           5 &   9.5 \\
witch doctor  &  heartless 2 +0.2  &  human 2 +0.2  &  insect 2 +0.2  &  scaled 2 +0.4  &   troll 2 +0.4  &  warlock  2 +0.4  &  warlock  4 +0.4  &                   &                  2.2 &           2 &   4.2 \\
\bottomrule
\end{tabular}
}
\caption{Оптимальный состав команды в для игры Dota UnderLords. }
\label{table:solution}
\end{table}


\section{Заключение}
\label{SectionConclusion}
В работе мы продемонстрировали как ключ к победе в популярной видео-игре может лежать в использовании линейного целочисленного математического программирования. 
Исходные данные и результаты решения модели в виде Jupyter-тетради могут быть найдены в открытом репозитории \cite{UnderLordsInput}.
Мы надеемся, что наша статья поможет привлечь внимание молодых умов к целочисленному программированию, методам дискретной оптимизации, а также к проблеме тысячелетия P $\neq ?$ NP. 
Важно, что математическая постановка задачи задаваемая набором неравенств \eqref{eq:DUIP} может  рассматриваться сама по себе, абстрагируясь от предметной области. И в данной работе показано, что кажущаяся на первый взгляд NP-hard задача, в версии "Да/Нет" является NP-полной. 
Таким образом данная работа делает вклад в исследование NP-полных задач. 

\bibliographystyle{unsrt}
\bibliography{references}

\end{document}




%
%\section{Частные разрешимые случаи}
%
%Как и многие подобные задачи, задача Dota Underlords становится полиномиально разрешимой при определённых ограничениях. 
%
%Рассмотрим простейший нетривиальный случай
%
%\begin{enumerate}
%    \item Каждый герой принадлежит ровно двум альянсам
%    \item Каждый альянс содержит ровно двух героев
%    \item Сила каждого героя равна $a$
%    \item Бонус от каждого альянса на каждого героя одинаков и равен $\frac{b}{2}$
%\end{enumerate}
%
%Таким образом, суммарный бонус от сбора альянса в данной модели равен $b$. 
%
%\begin{theorem}
%    Задача Dota Underlords в указанной формулировке решается за $O(nb)$, если $b$ - натуральное и NP-полна, если числа $a$ и $b$ - несравнимы. 
%\end{theorem}
%
%\begin{proof}
% Данную задачу удобно переформулировать на языке теории графов. Обозначим героев за вершины графа, а отношение "находятся в одном альянсе" - за ребро. Тогда в данном графе степени всех вершин равны 2 и он разбивается на несколько (возможно один) циклов, несвязных между собой. Т.к. число элементов в искомом наборе фиксировано, то итоговая целевая сумма зависит от числа рёбер, порождаемых в данном графе множеством взятых вершин-героев. Таким образом, если мы берём из некоторого цикла множество вершин мощности $k$, которое не совпадает с множеством всех вершин цикла, то мы можем получить самое большее бонус $(k-1)b$ - взяв вершины, порождающие путь в данном цикле. В случае, если мы берём весь цикл, то мы получаем бонус $kb$. таким образом, для достижения наибольшего бонуса необходимо, чтобы все взятые вершины порождали в графе некоторое множество циклов (возможно ноль) и не более одного пути. При этом, случай, когда пути вообще нет лучше случая, когда он есть. В случае, если нам надо взять всего $n$ элементов и мы смогли взять $n$ вершин, порождающих исключительно циклы, мы получаем итоговую сумму $n(a+b)$. Если же присутствует путь, то мы получаем сумму $na+(n-1)b$. Отметим, что фактически необходимо проверить возможность построения набора, порождающих исключительно циклы, т.к. построить набор, порождающий циклы и путь --- элементарно, достаточно добавлять циклы в набор в произвольном порядке, пока не окажется, что мы хотим добавить цикл размера большего, чем оставшееся количество вершин. Тогда вместо этого добавляем произвольный путь из этого цикла. 
% 
% Данная задача легко сводится к задаче о рюкзаке с целыми весами и решается методом динамического программирования. Действительно, размеры циклов в этой задаче соответствуют весам и объёму элементов, общее их количество в итоговом решении - объему рюкзака. Таким образом, необходимо лишь проверить, что в решении данного экземпляра задачи о рюкзаке рюкзак заполнится полностью.
% 
% Сложность алгоритма  в данной задаче равна $O(nb)$ при целом $b$. Задача тогда решается методом динамического программирования.
% 
% В случае произвольного $b$ данная задача представляет собой специфический случай задачи о сумме. Задачей о сумме называется задача в которой требуется определить, есть ли в данном множестве чисел подмножество с некоторой суммой $s$ (в каноническом случае - с суммой 0). Известно, что он - NP-полна Таким образом, задача Dota Underlords сводится к ней и значит NP-сложна. 
%\end{proof}


