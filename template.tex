\documentclass{article}
\usepackage{arxiv}
\usepackage[utf8]{inputenc} % allow utf-8 input
\usepackage[T1]{fontenc}    % use 8-bit T1 fonts
\usepackage{hyperref}       % hyperlinks
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography
\usepackage{lipsum}

\usepackage{amsmath, amsfonts, amsthm,amssymb}
\usepackage[english, russian]{babel}

\newtheorem{theorem}{Теорема}
\newtheorem{lemma}{Лемма}
\newtheorem{corollary}{Следствие}
\newtheorem{proposition}{Предложение}
\newtheorem{assertion}{Утверждение}

% \title{Theoretical Analysis of Random Geometric Hierarchical K-Graph}
% \title{NP-completeness and LP formulation of Dota Underlords problem}
 \title{Hacking Dota Underlords With Integer Programming Model}


\author{
  Alexander A. ~Ponomarenko, Dmitry S. ~Sirontkin\thanks{Use footnote for providing further
    information about author (webpage, alternative
    address)---\emph{not} for acknowledging funding agencies.} \\
  Laboratory of Algorithms and Technologies for Network Analysis\\
  National Research University Higher School of Economics \\
  Nizhny Novgorod, Russia\\
  \texttt{aponomarenko@hse.ru, dsirotkin@hse.ru} \\
  %% examples of more authors
  %% \AND
  %% Coauthor \\
  %% Affiliation \\
  %% Address \\
  %% \texttt{email} \\
  %% \And
  %% Coauthor \\
  %% Affiliation \\
  %% Address \\
  %% \texttt{email} \\
  %% \And
  %% Coauthor \\
  %% Affiliation \\
  %% Address \\
  %% \texttt{email} \\
}
%

\begin{document}
\maketitle

\begin{abstract}
В данной работе мы демонстрируем, как задача оптимального выбора состава команды в популярной компьютерной игре Dota UnderLords может быть сведелна к задаче целочисленного линейного программирования. Мы приводим модель и её решения. Также мы доказываем, что данная задача относится к классу NP-hard. 
\end{abstract}


% keywords can be removed
\keywords{Целочисленное программирование \and NP-hard }


\section{Описание Dota Underlords}
%Here will be our great introduction that will inspire everybody who reads it.

По ходу игры восемь игроков составляют команду из <<героев>> – существ, способных сражаться друг с другом на игровой карте. У каждого из героев есть базовые параметры - здоровье, урон, скорость атаки и прочие, а также особоая способность, которая определяет его роль в игре. Каждый герой принадлежит к двум или более <<альянсам>> - классам, в которые входят несколько героев. так, например, герой Enchantress принадлежит одновременно к альянсу <<друиды>> и к альянсу <<хищники>>. При наборе нескольких героев из одного альянса (для каждого альянса это число индивидуально) игрок получает бонус, который выражается в усилении всех героев из альянса, усилении всех своих героев или ослаблении всех героев соперника. Последнее может быть интерпретировано как относительное усиление своих героев и поэтому на протяжении работы будут рассматриваться только первые два случая. Следует отметить, что для одного альянса может быть несколько бонусов, которые открываются разным количеством героев соответствующего альянса, при этом они могут быть разного типа.

Также в ходе игры можно усилять своих героев до более высоких уровней или путём покупки внутриигровых предметов. В рамках данной работы эти аспекты учитываться не будут.

Таким образом, сила команды игрока определяется как:

\begin{enumerate}
    \item Силой выбранных героев
    \item Бонусами от альянсов в которых они состоят
\end{enumerate}

Как оказывается, данную задачу можно представить как задачу комбинаторной оптимизации. В рамках данной работы мы показываем её NP-полноту, приводим её формулировку как задачу ЛП и решаем её симплекс-методом для частного случая Dota Underlords.

\section{Перевод задачи в язык LP}

\subsection{Простейшая постановка задачи}

Формализуем задачу следующим образом:

Будем считать, что всего у нас в есть $n$ героев на выбор. Будем считать, что сила некоторого $i$-го героя опредяляется за некоторую неотрицательную величину $s_i$. За $x_i$ будем обозначать принадлежность героя выбранной команде. Условимся, что когда $x_i = 1$, если $i$-й герой принадлежит набранной команде и $x_i=0$ в противном случае. Тогда условие того, что в команде не более, чем $m$ героев можно записать в виде $\sum_{i=1}^n x_i \leq m$. Тогда в простейшей форме данную задачу можно сформулировать следующим образом:

\begin{equation}
\begin{gathered}
    max \sum_{i=1}^n x_i s_i \\
    \sum_{i=1}^n x_i \leq m \\
    x_i \in \{0, 1\} \text{ – управляющая переменная} \\
   n, m, s_i \text{ – костанты}  \\
\end{gathered}
\end{equation}

В данной постановке задача решается элементарно – достаточно взять $n$ элементов с наибольшими весами

\subsection{Постановка задачи с альянсами}
Как было упомянуто, в <<Dota Underlords>>  каждый герой принадлежит к двум или более <<альянсам>> - классам, в которые входят несколько героев.  Когда в команде присутствует несколько героев из одного альянса (для каждого альянса это число индивидуально) игрок получает бонус, который выражается в усилении всех героев из альянса, усилении всех своих героев или ослаблении всех героев соперника. Последнее может быть интерпретировано как относительное усиление своих героев и поэтому на протяжении работы будут рассматриваться только первые два случая. Следует отметить, что для одного альянса может быть несколько бонусов, которые открываются разным количеством героев соответствующего альянса, при этом они могут быть разного типа.

%В рамках нашей модели мы рассмотрим два типа альянсов – те которые дают бонусы своим членам и те, которые дают бонусы всем героям игрока. Пусть всего есть $t$ альянсов.

%В <<Dota Underlords>> для активации бонуса иногда можно собрать не весь альянс, а некоторую его часть – треть или половину. Более, того, могут существовать несколько подобных бонусов, например, один бонус за собранную треть альянса и бонус за собранные две трети альянса. Другим подобным случаем является случай, когда в игре присутствует больше героев в некотором альянсе, чем требуется для активации бонуса. 
%Мы будем считать, что бонус от альянса увеличивает силу героя на некоторую величину $e_{ijk}$, где $i$ -- номер героя, а $j$ -- номер альянса, $k$ -- номер уровня бонуса. 
Данную ситуцию мы предлагаем моделировать с помощью введения 3-х индексного тензора $e_{ijk} \in \mathbb{R}$ означающего бонус герою $i$, за альянс $j$, в котором присутствуют не меннее $k$ героев альянса $j$. Другими словами, $e_{ijk}$ это $k$-й бонус альянса $j$ для героя $i$.

С помошью тензора $e_{ijk}$ можно поддерижвать два типа альянсов – те которые дают бонусы своим членам и те, которые дают бонусы всем героям игрока. При этом, альянсы рассмотренных видов отличются только тем, что в альянсах, дающих бонус своим членам, величина $e_{ijk}$ равна нулю тогда и только тогда, когда $i$-й герой не принадлежит $j$-му альянсу. Заметим, что тензор  $e_{ijk}$  будет сильно разрежан, поскольку альянсы от которых бонусы идут всем гером не много.  
Контролировать вхождения бонуса $e_{ijk}$ в общую силу команды предлагается с помощью управляющей бинарной переменной $I_{ijk}$.
Так мы можем записать целевую функцию как следующую сумму $\sum_{i=1}^{n} x_i s_i + \sum_{i=1}^{n} \sum_{j=1}^{t} $.
Связь переменных $x_{i}$ и $I_{ijk}$ задаётся неравенствами
$\forall{i,j,k} :  \sum_{i'=1}^{n} a_{i'j} x_{i'} - k \ge M( I_{ijk}  - 1)$. \textbf{Здесь надо вставить пару предложений про эти неравенства, в чём логика этой связи}
Они недают бинарной переменной $I_{ijk}$ принимать значение 1, если в решение входит меньше чем $k$ героев входящих в альянс $j$. Когда решение содержит героев из альянса $j$ меньше чем $k$, левая часть этого неравенства отрицательная, поэтому чтобы неравентсва соблюдались правая часть должна быть ещё меньше. Такое возможно только, когда бинарная $I_{ijk}$ равно нулю. В этом случае правая часть равна $-М$, где $М$ константа заведомо большая, чем $k$, то есть больше, чем максимальный размер альянса $q$.
Разумно требовать, чтобы бонус для героя $i$ мог быть активирован ($I_{ijk} = 1$ ), только когда герой $i$ входит в решение. Это задаётся неравенствами $\forall{i,j,k} :  I_{ijk}  \le x_i$. Также мы хотим, чтобы бонус $e_{ijk}$ был активирован, только для если герой $i$ принадлежит альянсу $j$. Для этого мы в модель включили неравенства $\forall{i,j,k} :  I_{ijk}  \le a_{ij}$.   


Таким образом, после введения в модель альянсов, она выглядит следующим образом.
%Общая система уравнений выглядит следующим образом:
\begin{equation}
\begin{gathered}
\textbf{Целевая функция:}\\
max \sum_{i=1}^{n} x_i s_i + \sum_{i=1}^{n} \sum_{j=1}^{t}  \sum_{k=1}^{q} e_{ijk} I_{ijk} \\

\textbf{Ограничения на входные данные}\\
    
\forall{j} : \sum_{i=1}^n a_{ij} \le q \\

Ограничения на управляющие переменные \\
\forall{i,j,k} :  \sum_{i'=1}^{n} a_{i'j} x_{i'} - k \ge M( I_{ijk}  - 1) \\
\sum_{i=1}^n x_i \le m   \\ 

% \sum_{i=0}^{n-1} a_{ij} x_{i} < k \\ 

\forall{i,j,k} :  I_{ijk}  \le x_i \\

%\forall{i,j,k} :  I_{ijk}  \le a_{ij} \\

\text{Управляющие переменные:} \\
I_{ijk} \in \{0, 1\} \text {, 1 – если для героя } i \text{, активирован} k\text{-й бонус } j \text{-го альянса,} \\
x_i  \in \{0, 1\} \text{, 1 -- если герой } i \text{– входит в решение} \\

\textbf{Константы:} \\
n \in \mathbb{N} \text{ -- число героев,} \\
m \in \mathbb{N} \text{ -- максимальный размер команды}\\
t \in \mathbb{N} \text{ -- общее количество альянсов} \\
q \in \mathbb{N} \text{ -- максимальный размер одного альянса,} \\

s_i  \in \mathbb{R} \text{–- сила героя } i, \\
e_{ijk} \in \mathbb{R} \text{ -- бонус для героя } i \text{,  если активирован } k
\text{-й бонус } j \text{-го альянса} \\
a_{ij} \in \{0, 1\} \text{, 1 -- если герой } i \text{ входит в альянс } j \\ 
\end{gathered}
\end{equation}


\section{Доказательство NP-полноты задачи Dota Underlords с альянсами}

Покажем, что данная задача в указанной в предыдущем разделе формулировке является NP-полной. Рассмотрим её частный случай, удовлетворяющий следующему ограничениям 

\begin{enumerate}
    \item Веса элементов равны нулю
    \item Никакой элемент не принадлежит более чем одному классу
    \item Каждый элемент принадлежит хотя бы одному класу
\end{enumerate}

Очевидно, в рамках данной задачи брать только часть элементов из класса смысла не имеет, поскольку это не увеличит сумарный вес. Таким образом, мы либо берём весь класс, либо не берём. Это можно проинтерпретировать как задачу о рюкзаке, где <<предметом>>, который можно положить в рюкзак, является класс, его вес --- это количество элементов в нём, <<стоимость>> --- суммарный бонус класса, а <<вместимость рюкзака>> --- общее количество элементов, которые необходимо взять.

Данная задача является классической NP-полной задачей и сводится к задаче <<Dota Underlords>>.


\section{Практическое применение для реальной задачи Dota Underlords}
  
Мы применяем данную модель для анализа реальной задачи Dota Underlords. Отметим, что полученные результаты не стоит считать некоторой объективной оценкой качества команды героев. Причина состоит в неизбежном упрощении сил героев и влияния, которое оказывают альянсы. Каждый герой в Underlords обладает некоторой способностью, которая активируется при заполнении шкалы маны и обладает некоторым временем перезарядки. Способности и бонусы альянсов также весьма разнообразны по своему влиянию на игру - они могут наносить урон, лечить союзников, мешать врагам пользоваться своими способностями и прочее. К счастью, в игре есть система из пяти <<ярусов>>, устроенная так, что герои внутри яруса примерно равны по силе.

В рамках упрощённой модели мы принимаем следующее.

1) Силы всех героев первого яруса равны 1, второго 1.5, третьего - 2, чевертого - 2.5, пятого - 3

2) Все альянсы дают один и тот же мультипликативный бонус 1.1. Если у альянса больше одного уровня влияния на героев (например альянс воинов даёт своим героям последовательно +10, +15 и + 25 к броне), то второй уровень даёт мультипликативный бонус 1.2, третий - 1.3.

Особым случаем является альянс Scrappy, которой даёт бонус на своём первом уровне одному своему случайно выбранному члену. Мы считаем этот бонус равномерно распределённым между всеми членами альянса в рамках общей модели и считаем как и прочие бонусы первого уровня. Бонус второго уровня мы в этом альянсе считаем так же, как в других.

\section{Частные разрешимые случаи}

Как и многие подобные задачи, задача Dota Underlords становится полиномиально разрешимой при определённых ограничениях. 

Рассмотрим простейший нетривиальный случай

\begin{enumerate}
    \item Каждый герой принадлежит ровно двум альянсам
    \item Каждый альянс содережит ровно двух героев
    \item Сила каждого героя равна $a$
    \item Бонус от каждого альянса на каждого героя одинаков и равен $\frac{b}{2}$
\end{enumerate}

Таким образом, суммарный бонус от сбора альянса в данной модели равен $b$. 

\begin{theorem}
    Задача Dota Underlords в указанной формулировке решается за $O(nb)$, если $b$ - натуральное и NP-полна, если числа $a$ и $b$ - несравнимы. 
\end{theorem}

\begin{proof}
 Данную задачу удобно перефомулировать на языке теории графов. Обозначим героев за вершины графа, а отношение "находятся в одном альянсе" - за ребро. Тогда в данном графе степени всех вершин равны 2 и он разбивается на несколько (возможно один) циклов, несвязных между собой. Т.к. число элементов в искомом наборе фиксировано, то итоговая целевая сумма зависит от числа рёбер, порождаемых в данном графе множеством взятых вершин-героев. Таким образом, если мы берём из некоторого цикла множество вершин мощности $k$, которое не совпадает с множеством всех вершин цикла, то мы можем получить самое большее бонус $(k-1)b$ - взяв вершины, порождающие путь в данном цикле. В случае, если мы берём весь цикл, то мы получаем бонус $kb$. таким образом, для достижения наибольшего бонуса необходимо, чтобы все взятые вершины порождали в графе некоторое множество циклов (возяожно ноль) и не более одного пути. При этом, случай, когда пути вообще нет лучше случая, когда он есть. В случае, если нам надо взять всего $n$ элементов и мы смогли взять $n$ вершин, порождающих исключительно циклы, мы получаем итоговую сумму $n(a+b)$. Если же присутствует путь, то мы получаем сумму $na+(n-1)b$. Отметим, что фактически необходимо проверить возможность построения набора, порождающих исключительно циклы, т.к. построить набор, порождающий циклы и путь --- элементарно, достаточно добавлять циклы в набор в произвольнос порядке, пока не окажется, что мы хотим добавить цикл размера большего, чем оставшееся количество вершин. Тогда вместо этого добавляем произвольный путь из этого цикла. 
 
 Данная задача легко сводится к задаче о рюкзаке с целыми весами и решается методом динамического программирования. Действительно, размеры циклов в этой задаче соответсвуют весам и объёму элементов, общее их количество в итоговом решении - объёму рюкзака. Таким образом, наобходимо лишь проверить, что в решении данного экземпляра задачи о рюкзаке рюкзак заполнится полностью.
 
 Сложность алгоритма  в данной задаче равна $O(nb)$ при целом $b$. Задача тогда решается методом динамического программирования.
 
 В случае произвольного $b$ данная задача представлет собой специфический случай задачи о сумме. Задачей о сумме называется задача в которой требуется определить, есть ли в данном множестве чисел подмножество с некоторой суммой $s$ (в каноническом случае - с суммой 0). Известно, что он - NP-полна Таким образом, задача Dota Underlords сводится к ней и значит NP-сложна. 
\end{proof}

\section{Доказательство NP-трудности задачи Dota Underlords}
Покажем что задача Dota Underlords NP-трудна

Расммотрим её частный случай - пусть все альянсы имеют размер равный двум, и сила всех героев одинакова. Рассмотрим частный случай задачи Dota Underlords со следующими ограничениями:

\begin{enumerate}
    \item Силы всех героев одинаковы ($\forall i, j x_i=x_j$)
    \item Альянсы могут давать бонусы исключительно героям в них состоящим ($\forall i, j, k a_{ij}=0 \Longrightarrow e_{ijk} = 0$)
    \item Все альянсы имеют одинаковый размер, равный двум ($\forall j \sum_i a_{ij}=2$)
    \item Все альянсы дают бонус исключительно при наличии в них обоих героев ($\forall i, j e_{ij1}=0$)
    \item Бонусы ото всех альянсов равны ($\forall i, j, i', j' a_{ij}=1, a_{i' j'}=1 \Longrightarrow e_{ij2}=e_{i' j' 2}$)
\end{enumerate}

Тогда данные можно представить в виде графа $G(V, E)$, где множество вершин $V$ соответствует героям, а множество рёбер $E$ - активным альянсам. Задача поиска оптимальной команды размера $k$ таким образом сводится к поиску порождённого графа $G$ на $k$ вершинах с максимальной плотностью. Под плотностью в данной формулировке может понимается величина $\frac{G'(E)}{G'(V)}$. Действительно, при данных ограничениях общая сила команды линейно зависит от количества активных альянсов, что соответствует $G'(E)$. Т.к. $k$ неизменно, то с ростом плотности графа $G'$ растёт итоговая сила команды.

В работе \ref{DF95} было показано, что задача поиска порождённого подграфа с максимальной плотностью и фиксированным размером в графе является NP-полной. Как было показано, она является частным случаем задачи Dota Underlords и к ней сводится. Отсюда следует её NP-сложность.




 


%%% Comment out this section when you \bibliography{references} is enabled.
\begin{thebibliography}{1}



\end{thebibliography}


\end{document}
